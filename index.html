<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>충격파 균열 계산기</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#0f1724;
    --btn:#2b3440;
    --accent:#60a5fa;
    --text:#e6eef8;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 600px at 10% 10%, rgba(96,165,250,0.06), transparent 8%),
    linear-gradient(180deg,#071029 0%, #071826 100%);
    font-family:Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color:var(--text)}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}

  /* calculator container */
  .stage{
    position:relative;
    width:380px;
    max-width:96vw;
    border-radius:16px;
    padding:18px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow:0 18px 40px rgba(2,6,23,0.6);
    overflow:visible;
  }

  /* canvas overlay for cracks sits on top of calculator */
  canvas.crack-canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:30;
    border-radius:12px;
  }

  .display{
    background:rgba(2,6,23,0.6);
    border-radius:10px;
    padding:12px 14px;
    min-height:72px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-end;
    margin-bottom:12px;
    color:var(--text);
  }
  .display .expr{font-size:13px;color:#9aa6bf;margin-bottom:6px;min-height:16px}
  .display #result{font-size:28px;word-break:break-all;min-height:28px}

  .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  button.key{
    background:var(--btn);
    border:0;
    padding:14px;
    border-radius:8px;
    font-size:18px;
    color:var(--text);
    cursor:pointer;
    transition:transform .08s ease, box-shadow .12s ease, background .12s;
    box-shadow:inset 0 -2px 0 rgba(0,0,0,0.25);
    user-select:none;
  }
  button.key:active{transform:translateY(1px)}
  button.operation{background:#263244}
  button.equal{grid-column:span 2;background:linear-gradient(90deg,#60a5fa,#3b82f6);color:#021129;font-weight:700}
  button.wide{grid-column:span 2}

  .hint{font-size:12px;color:#8b97b1;margin-top:10px;text-align:center}

  /* shake animation when hit */
  @keyframes shake {
    0%{transform:translateX(0)}
    10%{transform:translateX(-6px)}
    20%{transform:translateX(6px)}
    30%{transform:translateX(-4px)}
    40%{transform:translateX(4px)}
    50%{transform:translateX(-2px)}
    60%{transform:translateX(2px)}
    100%{transform:translateX(0)}
  }
  .shake{animation:shake .35s linear both}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="calculator">
    <!-- canvas to draw cracks & shockwaves (size follows container) -->
    <canvas class="crack-canvas" id="crackCanvas"></canvas>

    <div class="display" aria-live="polite">
      <div class="expr" id="expression">&nbsp;</div>
      <div id="result">0</div>
    </div>

    <div class="keys" id="keys">
      <button class="key operation" data-action="clear">C</button>
      <button class="key operation" data-action="back">⌫</button>
      <button class="key operation" data-value="%">%</button>
      <button class="key operation" data-value="/">÷</button>

      <button class="key" data-value="7">7</button>
      <button class="key" data-value="8">8</button>
      <button class="key" data-value="9">9</button>
      <button class="key operation" data-value="*">×</button>

      <button class="key" data-value="4">4</button>
      <button class="key" data-value="5">5</button>
      <button class="key" data-value="6">6</button>
      <button class="key operation" data-value="-">−</button>

      <button class="key" data-value="1">1</button>
      <button class="key" data-value="2">2</button>
      <button class="key" data-value="3">3</button>
      <button class="key operation" data-value="+">+</button>

      <button class="key wide" data-value="0">0</button>
      <button class="key" data-value=".">.</button>
      <button class="key equal" data-action="equals">=</button>
    </div>

    <div class="hint">키보드 지원: 숫자, + - * / . Enter(=), Backspace, Escape(C), %</div>
  </div>
</div>

<script>
/* ---------------------------
   Calculator logic (robust)
   --------------------------- */
const expressionEl = document.getElementById('expression');
const resultEl = document.getElementById('result');
const keys = document.getElementById('keys');
const stage = document.getElementById('calculator');

let expr = '';

function updateDisplay(){
  expressionEl.textContent = expr || '\u00A0';
  resultEl.textContent = expr ? previewResult(expr) : '0';
}

function previewResult(e){
  try{
    const s = sanitize(e);
    if(!s.trim()) return '0';
    const val = Function('return (' + s + ')')(); // evaluate sanitized expression
    if(val === undefined || Number.isNaN(val)) return '오류';
    return formatNumber(val);
  }catch(e){
    return '오류';
  }
}

function formatNumber(n){
  if(!isFinite(n)) return '무한';
  // limit decimals reasonably
  if(Math.abs(n) < 1e12 && Math.abs(n - Math.round(n)) > 1e-12){
    return parseFloat(n.toFixed(10)).toString();
  }
  return n.toString();
}

function sanitize(s){
  // allow digits, operators, parentheses, percent, spaces, dot
  if(!/^[0-9+\-*/().% \t\n]*$/.test(s)) throw new Error('금지 문자 포함');
  // convert occurrences like 50% -> (50/100)
  return s.replace(/(\d+(?:\.\d+)?)%/g, '($1/100)');
}

function appendChar(ch){
  // basic guard: don't start with +*/.
  if(expr === '' && /[+*/]/.test(ch)) return;
  expr += ch;
  updateDisplay();
}

function backspace(){
  expr = expr.slice(0, -1);
  updateDisplay();
}

function clearAll(){
  expr = '';
  updateDisplay();
}

function calculate(){
  try{
    const s = sanitize(expr);
    const value = Function('return (' + s + ')')();
    if(value === undefined || Number.isNaN(value)){
      resultEl.textContent = '오류';
    }else{
      expr = String(value);
      updateDisplay();
    }
  }catch(e){
    resultEl.textContent = '오류';
  }
}

/* handle clicks and keyboard */
keys.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const v = btn.getAttribute('data-value');
  const action = btn.getAttribute('data-action');

  // trigger crack effect centered at button
  const rect = btn.getBoundingClientRect();
  const stageRect = stage.getBoundingClientRect();
  const cx = rect.left + rect.width/2 - stageRect.left;
  const cy = rect.top + rect.height/2 - stageRect.top;
  triggerEffects(cx, cy);

  if(action === 'clear') { clearAll(); return; }
  if(action === 'back') { backspace(); return; }
  if(action === 'equals') { calculate(); return; }
  if(v) { appendChar(v); return; }
});

window.addEventListener('keydown', (ev)=>{
  // map keys
  if(ev.key === 'Enter'){ ev.preventDefault(); triggerEffectsAtCenter(); calculate(); return; }
  if(ev.key === 'Backspace'){ ev.preventDefault(); triggerEffectsAtCenter(); backspace(); return; }
  if(ev.key === 'Escape'){ ev.preventDefault(); triggerEffectsAtCenter(); clearAll(); return; }
  if(/^[0-9+\-*/().%]$/.test(ev.key)){
    ev.preventDefault();
    appendChar(ev.key);
    triggerEffectsAtCenter();
  }
});

/* when keyboard triggered, use center of calculator as effect origin */
function triggerEffectsAtCenter(){
  const r = stage.getBoundingClientRect();
  triggerEffects(r.width/2, r.height/2);
}

/* ---------------------------
   Crack & Shockwave animation
   --------------------------- */

const canvas = document.getElementById('crackCanvas');
const ctx = canvas.getContext('2d');

function resizeCanvas(){
  // make canvas pixel-perfect for devicePixelRatio
  const rect = stage.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.round(rect.width * dpr);
  canvas.height = Math.round(rect.height * dpr);
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let cracks = [];    // each crack: {segments: [ {x,y}... ], life, alpha}
let waves = [];     // each wave: {x,y,r,alpha, maxR}
let particles = []; // small flying shards

function triggerEffects(x, y){
  // x,y are coordinates relative to stage top-left
  createCrack(x, y);
  createWave(x, y);
  createShards(x, y);
  // small shake of calculator
  stage.classList.remove('shake');
  // force reflow to restart
  void stage.offsetWidth;
  stage.classList.add('shake');
}

function createCrack(x, y){
  const numBranches = 6 + Math.floor(Math.random()*5);
  const branchMaxLen = Math.max(80, Math.min(220, 100 + Math.random()*120));
  const segmentsAll = [];
  for(let b=0;b<numBranches;b++){
    const angle = (Math.PI*2) * Math.random();
    const segs = [];
    let px = x, py = y;
    let remaining = branchMaxLen * (0.5 + Math.random()*0.8);
    let curAngle = angle;
    while(remaining > 8){
      const step = 6 + Math.random()*18;
      const jitter = (Math.random()-0.5) * (Math.PI/6);
      curAngle += jitter;
      const nx = px + Math.cos(curAngle) * step;
      const ny = py + Math.sin(curAngle) * step;
      segs.push({x:nx, y:ny});
      px = nx; py = ny;
      remaining -= step;
      // sometimes split
      if(Math.random() < 0.06 && remaining > 20){
        // push a small sub-branch as separate crack
        const subLen = remaining * (0.4 + Math.random()*0.6);
        const subSegs = [];
        let sx = px, sy = py;
        let sAng = curAngle + (Math.random()-0.5)*1.2;
        let subRem = subLen;
        while(subRem>6){
          const sStep = 5 + Math.random()*12;
          sAng += (Math.random()-0.5)*0.8;
          sx = sx + Math.cos(sAng) * sStep;
          sy = sy + Math.sin(sAng) * sStep;
          subSegs.push({x:sx,y:sy});
          subRem -= sStep;
        }
        segmentsAll.push(subSegs);
      }
    }
    if(segs.length) segmentsAll.push(segs);
  }
  cracks.push({origin:{x,y}, branches:segmentsAll, age:0, life:120 + Math.floor(Math.random()*80), alpha:1});
}

function createWave(x, y){
  const maxR = Math.max(canvas.width, canvas.height) * (0.8 + Math.random()*0.8);
  waves.push({x,y,r:4,alpha:0.9,maxR});
}

function createShards(x,y){
  const count = 8 + Math.floor(M
